[{"Body":{"ClassId":"workflow.TaskDefinition","DefaultVersion":true,"Label":"VBR - Add Managed Server v1.0","Name":"VBR-AddManagedServerv1.0","ObjectType":"workflow.TaskDefinition","Properties":{"ExternalMeta":true,"InputDefinition":[{"CustomDataTypeProperties":{"CatalogMoid":"shared","ObjectType":"workflow.CustomDataProperty"},"Default":{"ObjectType":"workflow.DefaultValue"},"Description":"The PowerShell endpoint on which the script is to be executed. PowerShell Remoting must be enabled on the endpoint to allow for scripts to be executed remotely.\n","DisplayMeta":{"InventorySelector":true,"ObjectType":"workflow.DisplayMeta","WidgetType":"Dropdown"},"Label":"External Target","Name":"Target","ObjectType":"workflow.TargetDataType","Properties":[{"DisplayAttributes":["Name","TargetType"],"ObjectType":"workflow.TargetProperty","Selector":"/api/v1/asset/Targets?$filter=(TargetType eq PowerShellEndpoint and Status eq Connected)","SelectorProperty":{"Method":"GET","ObjectType":"workflow.SelectorProperty"},"SupportedObjects":["asset.Target"]}],"Required":true},{"Default":{"ObjectType":"workflow.DefaultValue"},"Description":"Veeam-managed server to add","DisplayMeta":{"InventorySelector":true,"ObjectType":"workflow.DisplayMeta","WidgetType":"None"},"Label":"Server Name","Name":"servername","ObjectType":"workflow.PrimitiveDataType","Properties":{"Constraints":{"EnumList":[],"ObjectType":"workflow.Constraints"},"InventorySelector":[],"ObjectType":"workflow.PrimitiveDataProperty","Type":"string"}},{"Default":{"ObjectType":"workflow.DefaultValue"},"DisplayMeta":{"InventorySelector":true,"ObjectType":"workflow.DisplayMeta","WidgetType":"None"},"Label":"Host Platform","Name":"hostplatform","ObjectType":"workflow.PrimitiveDataType","Properties":{"Constraints":{"EnumList":[{"Label":"Windows","ObjectType":"workflow.EnumEntry","Value":"0"},{"Label":"Linux","ObjectType":"workflow.EnumEntry","Value":"1"}],"ObjectType":"workflow.Constraints"},"InventorySelector":[],"ObjectType":"workflow.PrimitiveDataProperty","Type":"enum"},"Required":true},{"Default":{"ObjectType":"workflow.DefaultValue"},"DisplayMeta":{"InventorySelector":true,"ObjectType":"workflow.DisplayMeta","WidgetType":"None"},"Label":"User Name","Name":"username","ObjectType":"workflow.PrimitiveDataType","Properties":{"Constraints":{"EnumList":[],"ObjectType":"workflow.Constraints"},"InventorySelector":[],"ObjectType":"workflow.PrimitiveDataProperty","Type":"string"}},{"Default":{"ObjectType":"workflow.DefaultValue"},"DisplayMeta":{"InventorySelector":true,"ObjectType":"workflow.DisplayMeta","WidgetType":"None"},"Label":"Credential Description","Name":"credentialdesc","ObjectType":"workflow.PrimitiveDataType","Properties":{"Constraints":{"EnumList":[],"ObjectType":"workflow.Constraints"},"InventorySelector":[],"ObjectType":"workflow.PrimitiveDataProperty","Type":"string"},"Required":true}],"ObjectType":"workflow.Properties","OutputDefinition":[],"RetryDelay":60,"RetryPolicy":"Fixed","SupportStatus":"Supported","Timeout":300,"TimeoutPolicy":"Timeout"},"RollbackTasks":[],"SharedScope":"user","Version":1},"ClassId":"bulk.RestSubRequest","ObjectType":"bulk.RestSubRequest","TargetMoid":"","Uri":"/v1/workflow/TaskDefinitions","Verb":"POST"},{"Body":{"Batch":[{"Body":"#\r\n# Add a new managed server to VBR with the pre-existing credentials (indexed by username and\r\n# user description).  If the managed server already exists or if the specified credentials\r\n# do not exist an error is returned otherwise the new managed server is created per the \r\n# platform (Windows, Linux) specified.\r\n#\r\n# Inputs: workflow inputs with references \"servername\", existing managed credentials\r\n# referenced by \"username\" and  \"userdescription\" and \"hostplatform\" (0 - Windows, 1 - Linux)\r\n#\r\ntry {\r\n    $managedServer = Get-VBRServer -Name \"{{.global.task.input.servername}}\"\r\n    if ($managedServer -EQ $null) {\r\n        $cred = Get-VBRCredentials | Where-Object {$_.Description -eq \"{{.global.task.input.credentialdesc}}\" -and $_.Name -eq \"{{.global.task.input.username}}\"}\r\n        if ($cred -ne $null) {\r\n            Switch ({{.global.task.input.hostplatform}}) {\r\n                0 {\r\n                    Write-Output \"Adding windows host\"\r\n                    Add-VBRWinServer -Name \"{{.global.task.input.servername}}\" -Credentials $cred\r\n                    }\r\n                1 {        \r\n                    Write-Output \"Adding linux host\"\r\n                    Add-VBRLinux -Name \"{{.global.task.input.servername}}\" -Credentials $cred -confirm:$False\r\n                    }\r\n            }\r\n        }\r\n        else {\r\n            Write-Error -Message \"Credentials not found!\"\r\n            exit 1\r\n        }\r\n    }\r\n    else {\r\n        Write-Error -Message \"Managed server already exists\"\r\n        exit 0\r\n    }\r\n    exit 0\r\n}\r\ncatch { \r\n    Write-Output \"Exception in add managed server\" \r\n    exit 1 \r\n}","ContentType":"json","Description":"Add managed Linux or Windows host to VBR","Label":"VBR Add Managed Server","Name":"InvokePowerShellScript1","ObjectType":"workflow.PowerShellApi","OperationTimeout":"300","Outcomes":[],"PowerShellResponseSpec":{"Parameters":[]}}],"CancelAction":[],"ClassId":"workflow.PowerShellBatchApiExecutor","Constraints":{"ObjectType":"workflow.TaskConstraints"},"Name":"VBR - Add Managed Server v1.0","ObjectType":"workflow.PowerShellBatchApiExecutor","Output":{},"SharedScope":"user","TaskDefinition":{"ObjectType":"workflow.TaskDefinition","Selector":"Name eq \"VBR-AddManagedServerv1.0\" and Version eq 1"}},"ClassId":"bulk.RestSubRequest","ObjectType":"bulk.RestSubRequest","TargetMoid":"","Uri":"/v1/workflow/PowerShellBatchApiExecutors","Verb":"POST"}]